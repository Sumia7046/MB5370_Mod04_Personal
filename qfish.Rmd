---
title: "QFISH"
author: "Sumia Kabir Munia"
date: "2025-09-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(janitor)
```


```{r}
data <- read.csv("C:/Users/sumia/OneDrive/Documents/MB5370/GitHub/MB5370_Mod04_Personal/data/export.csv")
# Quick peek
dim(data); data[1:5, 1:12]
view(data)
```

```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(stringr)
})

# 0) Treat your object as raw matrix with the first 2 rows as headers
raw <- as.data.frame(data, stringsAsFactors = FALSE)
```

```{r}
# ===== START HERE (works with your existing `data`) =====
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
})

# 0) Treat `data` as a raw table where:
#    row 1 = Year headers, row 2 = Species headers, col 1 = Area, rows 3+ = data
raw <- as.data.frame(data, stringsAsFactors = FALSE)
raw[] <- lapply(raw, \(x) as.character(x))  # make everything character

# Helpers
ffill <- function(x) {               # forward-fill year labels across row 1
  last <- NA_character_
  for (i in seq_along(x)) {
    if (!is.na(x[i]) && nzchar(x[i])) last <- x[i]
    if (is.na(x[i]) || !nzchar(x[i])) x[i] <- last
  }
  x
}
norm_group <- function(g) {          # normalize species labels to 4 groups; drop totals/calendar
  g <- tolower(trimws(ifelse(is.null(g), "", g)))
  g <- gsub("[^a-z0-9]+", " ", g)
  g <- trimws(g)
  if (g == "" || grepl("total|calendar", g)) return(NA_character_)
  if (g %in% c("shark","sharks"))   return("Shark")
  if (g %in% c("turtle","turtles")) return("Turtle")
  if (g %in% c("mammal","mammals")) return("Mammal")
  if (g %in% c("other","others"))   return("Other")
  return(NA_character_)             # anything else = ignore
}

# 1) Header rows & area vector
hdr_year  <- as.character(raw[1, ])
hdr_group <- as.character(raw[2, ])
area_vec  <- as.character(raw[-c(1,2), 1])

yr_ff <- ffill(hdr_year)

# 2) Build tidy rows column-by-column (robust: no pivot_longer required)
parts <- list()
ncol_raw <- ncol(raw)
for (j in 2:ncol_raw) {
  # extract year (4 digits anywhere in header cell)
  yr <- sub(".*?(\\b[0-9]{4}\\b).*", "\\1", yr_ff[j])
  if (!grepl("\\b[0-9]{4}\\b", yr_ff[j])) next
  grp <- norm_group(hdr_group[j])
  if (is.na(grp)) next

  vals <- suppressWarnings(as.numeric(raw[-c(1,2), j]))
  parts[[length(parts) + 1]] <- data.frame(
    Area = area_vec,
    Year = as.integer(yr),
    SpeciesGroup = grp,
    Count = vals,
    stringsAsFactors = FALSE
  )
}

tidy <- dplyr::bind_rows(parts)
tidy <- subset(tidy, !is.na(Area) & Area != "" & !is.na(Year) & !is.na(Count))
tidy <- subset(tidy, SpeciesGroup %in% c("Mammal","Shark","Turtle","Other"))
tidy <- subset(tidy, !grepl("grand\\s*total", Area, ignore.case = TRUE))

# Quick sanity check — you should see four groups with counts:
print(dplyr::count(tidy, SpeciesGroup, sort = TRUE))

# ===== PLOTS =====

# A) SIMPLE, SPECIFIC: Statewide sharks by year (bar chart)
p_sharks_statewide <- tidy |>
  dplyr::filter(SpeciesGroup == "Shark") |>
  dplyr::group_by(Year) |>
  dplyr::summarise(Total = sum(Count, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = Year, y = Total)) +
  geom_col() +
  labs(
    title = "Total sharks caught statewide per year (Shark Control Program)",
    x = "Year", y = "Number of sharks caught"
  ) +
  theme_minimal(base_size = 13)

p_sharks_statewide  # <-- view this

# B) (Optional) Very clear composition (all areas combined): 100% stacked
# Uncomment to view
# library(scales)
# p_comp <- tidy |>
#   dplyr::group_by(Year, SpeciesGroup) |>
#   dplyr::summarise(Total = sum(Count, na.rm = TRUE), .groups = "drop") |>
#   dplyr::group_by(Year) |>
#   dplyr::mutate(Share = Total / sum(Total)) |>
#   ggplot(aes(x = Year, y = Share, fill = SpeciesGroup)) +
#   geom_col(width = 0.9) +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#   labs(title = "Catch composition by year (statewide, 100% stacked)",
#        x = "Year", y = "Share of annual catch", fill = "Group") +
#   theme_minimal(base_size = 13)
# p_comp
# ===== END =====
```

`
```{r}
p_species_trend <- tidy %>%
  group_by(Year, SpeciesGroup) %>%
  summarise(Total = sum(Count, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = Year, y = Total, color = SpeciesGroup)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Total catches by species group across Queensland",
    x = "Year", y = "Number caught", color = "Group"
  ) +
  theme_minimal(base_size = 13)

p_species_trend

```


##-------------Map-------------##
```{r}
library(sf)
library(dplyr)
library(ggplot2)
```
```{r}
# 1. read shapefile (point to the .shp file directly)
lga <- st_read("C:/Users/sumia/OneDrive/Documents/MB5370/GitHub/MB5370_Mod04_Personal/data/1259030001_lga11aaust_shape/lga11aaust.shp")
```
```{r}
names(lga)
head(lga, 3)
```

   
```{r}
library(ggrepel)
library(dplyr)
library(sf)
library(scales)

non_na <- map_data %>% filter(!is.na(TotalSharks))
TOP_N <- 8

# --- Base labels ---
labs0 <- non_na %>%
  arrange(desc(TotalSharks)) %>%
  slice_head(n = TOP_N) %>%
  st_point_on_surface() %>%
  mutate(
    X = st_coordinates(geometry)[,1],
    Y = st_coordinates(geometry)[,2],
    label = paste0(LGA_NAME11, ": ", comma(TotalSharks))
  ) %>% 
  st_drop_geometry()

# --- Manual tweaks just for Bundaberg & Gold Coast ---
offsets <- tibble::tribble(
  ~LGA_NAME11,   ~dx,   ~dy,
  "Bundaberg (R)",  0.3,  -1.2,   # push east & up
  "Gold Coast (C)", 0.3, -0.15    # push east & down
)

labs <- labs0 %>%
  left_join(offsets, by = "LGA_NAME11") %>%
  mutate(
    dx = coalesce(dx, 0),
    dy = coalesce(dy, 0),
    Xlab = X + dx,
    Ylab = Y + dy
  )
labs <- labs %>%
  mutate(
    label = paste0(str_replace(LGA_NAME11, "\\s*\\(.*\\)", ""), ": ", comma(TotalSharks))
  )


# --- Plot ---
bb <- st_bbox(qld_lga)
xpad <- (bb["xmax"] - bb["xmin"]) * 0.25

p_map <- ggplot() +
  geom_sf(data = qld_lga, fill = "grey85", colour = "white", linewidth = 0.2) +
  geom_sf(data = non_na, aes(fill = TotalSharks), colour = "white", linewidth = 0.25) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  geom_text_repel(
    data = labs, aes(Xlab, Ylab, label = label),
    size = 3, colour = "black", seed = 123,
    nudge_x = 0.6, direction = "y",
    box.padding = 0.3, point.padding = 0.3,
    min.segment.length = 0, segment.size = 0.3, segment.alpha = 0.8
  ) +
  coord_sf(
    xlim = c(bb["xmin"], bb["xmax"] + xpad),
    ylim = c(bb["ymin"], bb["ymax"]),
    expand = FALSE, datum = NA, clip = "off"
  ) +
  labs(title = "Shark Control Program — shark catches by LGA (Queensland)",
       fill = "Total sharks") +
  theme_minimal(base_size = 12) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())


p_map

```



