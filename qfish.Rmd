---
title: "QFISH"
author: "Sumia Kabir Munia"
date: "2025-09-19"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(janitor)
```

```{r}
data <- read.csv("C:/Users/sumia/OneDrive/Documents/MB5370/GitHub/MB5370_Mod04_Personal/data/export.csv")
dim(data); data[1:5, 1:12]
view(data)
```
###----------Tidy Data------------###
```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(stringr)
})
```

```{r}
#    row 1 = Year headers, row 2 = Species headers, col 1 = Area, rows 3 = data
# make everything character
raw <- as.data.frame(data, stringsAsFactors = FALSE)
raw[] <- lapply(raw, \(x) as.character(x))  
```

```{r}
# Helpers
#Normalize species labels to the four groups we care about and drop totals/calendars
ffill <- function(x) {               
  last <- NA_character_
  for (i in seq_along(x)) {
    if (!is.na(x[i]) && nzchar(x[i])) last <- x[i]
    if (is.na(x[i]) || !nzchar(x[i])) x[i] <- last
  }
  x
}
norm_group <- function(g) {          
  g <- tolower(trimws(ifelse(is.null(g), "", g)))
  g <- gsub("[^a-z0-9]+", " ", g)
  g <- trimws(g)
  if (g == "" || grepl("total|calendar", g)) return(NA_character_)
  if (g %in% c("shark","sharks"))   return("Shark")
  if (g %in% c("turtle","turtles")) return("Turtle")
  if (g %in% c("mammal","mammals")) return("Mammal")
  if (g %in% c("other","others"))   return("Other")
  return(NA_character_)             # anything else = ignore
}
```

```{r}
## Header rows & area vector
hdr_year  <- as.character(raw[1, ])
hdr_group <- as.character(raw[2, ])
area_vec  <- as.character(raw[-c(1,2), 1])
# Forward-fill year row so every data column has a year
yr_ff <- ffill(hdr_year)
```


##--Build tidy rows column-by-column--##
```{r}
parts <- list()
ncol_raw <- ncol(raw)
for (j in 2:ncol_raw) {
  # extract year (4 digits anywhere in header cell)
  yr <- sub(".*?(\\b[0-9]{4}\\b).*", "\\1", yr_ff[j])
  if (!grepl("\\b[0-9]{4}\\b", yr_ff[j])) next
  grp <- norm_group(hdr_group[j])
  if (is.na(grp)) next

  vals <- suppressWarnings(as.numeric(raw[-c(1,2), j]))
  parts[[length(parts) + 1]] <- data.frame(
    Area = area_vec,
    Year = as.integer(yr),
    SpeciesGroup = grp,
    Count = vals,
    stringsAsFactors = FALSE
  )
}
##Bind and clean: remove blanks/NA areas, keep only our 4 groups, drop "grand total" rows
tidy <- dplyr::bind_rows(parts)
tidy <- subset(tidy, !is.na(Area) & Area != "" & !is.na(Year) & !is.na(Count))
tidy <- subset(tidy, SpeciesGroup %in% c("Mammal","Shark","Turtle","Other"))
tidy <- subset(tidy, !grepl("grand\\s*total", Area, ignore.case = TRUE))

print(dplyr::count(tidy, SpeciesGroup, sort = TRUE))


```
##-------PLOT-------##
#Statewide trends for all four species groups 
```{r}
p_species_trend <- tidy %>%
  group_by(Year, SpeciesGroup) %>%
  summarise(Total = sum(Count, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = Year, y = Total, color = SpeciesGroup)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 2) +
  labs(
    title = "Total catches by species group across Queensland",
    x = "Year", y = "Number caught", color = "Group"
  ) +
  theme_minimal(base_size = 13)

p_species_trend

```

## Statewide sharks by year (bar chart)##
```{r}
p_sharks_statewide <- tidy |>
  dplyr::filter(SpeciesGroup == "Shark") |>
  dplyr::group_by(Year) |>
  dplyr::summarise(Total = sum(Count, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = Year, y = Total, fill = factor(Year))) +
  geom_col() +
  scale_fill_viridis_d(option = "plasma") +   
  labs(
    title = "Total sharks caught statewide per year (Shark Control Program)",
    x = "Year", y = "Number of sharks caught",
    fill = "Year"
  ) +
  theme_minimal(base_size = 13)

p_sharks_statewide


```

##-------------Map-------------##
```{r}
library(sf)
```

```{r}
lga <- st_read("C:/Users/sumia/OneDrive/Documents/MB5370/GitHub/MB5370_Mod04_Personal/data/1259030001_lga11aaust_shape/lga11aaust.shp")
```

```{r}
names(lga)
head(lga, 3)
```

   
```{r}
library(ggrepel)
library(scales)
```




```{r}
# --- Build the mapping data BEFORE plotting ---

# 1) Keep only Queensland LGAs + name cleaner
clean_area <- function(x){
  x %>%
    stringr::str_to_lower() %>%
    stringr::str_replace_all("&"," and ") %>%
    stringr::str_replace_all("\\(.*?\\)"," ") %>%
    stringr::str_replace_all("regional|city|shire|council|lga"," ") %>%
    stringr::str_replace_all("[^a-z0-9]+"," ") %>%
    stringr::str_squish()
}

qld_lga <- lga %>%
  dplyr::filter(STATE_CODE == 3) %>%
  dplyr::select(LGA_NAME11, geometry) %>%
  dplyr::mutate(LGA_clean = clean_area(LGA_NAME11))

# 2) Shark totals across ALL years (use filter(Year == XXXX) if you need a single year)
shark_totals <- tidy %>%
  dplyr::filter(SpeciesGroup == "Shark") %>%
  dplyr::group_by(Area) %>%
  dplyr::summarise(TotalSharks = sum(Count, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(Area_clean = clean_area(Area))

# 3) Join polygons + totals  (avoid the name 'map_data' to not clash with ggplot2)
shp_join <- qld_lga %>%
  dplyr::left_join(shark_totals, by = c("LGA_clean" = "Area_clean"))

# 4) Quick checks (optional, but helpful)
print(names(shp_join))
print(head(shp_join %>% sf::st_drop_geometry() %>% dplyr::select(LGA_NAME11, TotalSharks)))


non_na <- shp_join %>% dplyr::filter(!is.na(TotalSharks))
bb     <- sf::st_bbox(qld_lga)

# ... later in ggplot:
geom_sf(data = non_na, aes(fill = TotalSharks), colour = "white", linewidth = 0.25)

anti_join(shark_totals, qld_lga %>% dplyr::select(LGA_clean), 
          by = c("Area_clean" = "LGA_clean")) %>% dplyr::distinct(Area)

```

```{r}
# --- empty overrides so knit never fails ---

if (!exists("overrides")) {
  overrides <- tibble::tibble(Area = character(), LGA_clean = character())
}

```

```{r}
shark_totals <- shark_totals %>%
  dplyr::left_join(overrides, by = "Area") %>%                 # safe now
  dplyr::mutate(Area_clean = dplyr::coalesce(LGA_clean, Area_clean)) %>%
  dplyr::select(-LGA_clean)

```

```{r}

shark_totals <- shark_totals %>%
  dplyr::left_join(overrides, by = "Area") %>%
  dplyr::mutate(Area_clean = dplyr::coalesce(LGA_clean, Area_clean)) %>%
  dplyr::select(-LGA_clean)

shp_join <- qld_lga %>% dplyr::left_join(shark_totals, by = c("LGA_clean" = "Area_clean"))

# sanity check (should show some non-NA numbers)
shp_join %>% sf::st_drop_geometry() %>% dplyr::count(is.na(TotalSharks))
head(shp_join %>% sf::st_drop_geometry() %>% dplyr::select(LGA_NAME11, TotalSharks))
non_na <- shp_join %>% dplyr::filter(!is.na(TotalSharks))
# --- label data (top N) ---
TOP_N <- 8
labs0 <- non_na %>%
  dplyr::arrange(dplyr::desc(TotalSharks)) %>%
  dplyr::slice_head(n = TOP_N) %>%
  sf::st_point_on_surface() %>%
  dplyr::mutate(
    X = sf::st_coordinates(geometry)[,1],
    Y = sf::st_coordinates(geometry)[,2],
    label = paste0(stringr::str_replace(LGA_NAME11, "\\s*\\(.*\\)", ""), ": ",
                   scales::comma(TotalSharks))
  ) %>% sf::st_drop_geometry()

# --- tiny manual nudges for the crowded coastal councils ---
# dx, dy are in degrees (small numbers). 
offsets <- tibble::tribble(
  ~LGA_NAME11,        ~dx,   ~dy,
  "Cairns (R)",        0.85,  0.00,
  "Townsville (C)",    2.00,  0.40,
  "Mackay (R)",        2.00,  0.60,
  "Gladstone (R)",     2.50, -0.10,
  "Bundaberg (R)",     0.55, -1.10,
  "Gold Coast (C)",    0.80, -1
)

labs <- labs0 %>%
  dplyr::left_join(offsets, by = "LGA_NAME11") %>%
  dplyr::mutate(
    dx = dplyr::coalesce(dx, 0),
    dy = dplyr::coalesce(dy, 0),
    Xlab = X + dx,
    Ylab = Y + dy
  )

# --- more horizontal space for off-coast labels ---
bb   <- sf::st_bbox(qld_lga)
xpad <- (bb["xmax"] - bb["xmin"]) * 0.45  

p_map <- ggplot() +
  geom_sf(data = qld_lga, fill = "grey85", colour = "white", linewidth = 0.3) +
  geom_sf(data = non_na, aes(fill = TotalSharks), colour = "white", linewidth = 0.25) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  ggrepel::geom_text_repel(
    data = labs, aes(Xlab, Ylab, label = label),
    size = 2.5, colour = "black", seed = 123,
    direction = "y",            
    nudge_x = 0.4,             
    box.padding = 0.0, point.padding = 0.3,
    force = 6, force_pull = 0.6,
    min.segment.length = 0, segment.size = 0.3, segment.alpha = 0.9
  ) +
  coord_sf(
    xlim = c(bb["xmin"], bb["xmax"] + xpad),
    ylim = c(bb["ymin"], bb["ymax"]),
    expand = FALSE, datum = NA, clip = "off"
  ) +
  labs(title = "Shark Control Program â€” shark catches by LGA (Queensland)",
       fill  = "Total sharks") +
  theme_minimal(base_size = 12) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())

p_map

shark_totals <- shark_totals %>%
  dplyr::left_join(overrides, by = "Area") %>%
  dplyr::mutate(Area_clean = dplyr::coalesce(LGA_clean, Area_clean)) %>%
  dplyr::select(-LGA_clean)


```






